window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;width=window.innerWidth;height=window.innerHeight;canvas=document.createElement("canvas");canvas.style.margin=0;canvas.style.padding=0;document.body.style.margin=0;document.body.style.padding=0;c=canvas.getContext("2d");canvas.width=width;canvas.height=height;center_x=width/2;center_y=height/2;canvas.style.width=canvas.width+"px";canvas.style.height=canvas.height+"px";document.body.appendChild(canvas);gesture=false;select=null;function handleEvent(b){switch(b.type){case"touchstart":b.preventDefault();var e=b.touches[0];touch_x=Number(e.pageX);touch_y=Number(e.pageY);var a=touch_x;var d=touch_y;if(requestID===0){if(c.isPointInPath(a,d)){restart()}}select=null;if(player.x-player.w/2<a&&player.x+player.w/2>a&&player.y-player.h/2<d&&player.y+player.h/2>d){select=player;cha_x=touch_x-select.x;cha_y=touch_y-select.y}break;case"touchmove":b.preventDefault();var e=b.touches[0];touch_x=Number(e.pageX);touch_y=Number(e.pageY);if(select!=null){select.x=touch_x-cha_x;select.y=touch_y-cha_y}break;case"touchend":b.preventDefault();break;case"gesturestart":player_fires.push({role:"player_fire",x:player.x,y:player.y,w:10,h:10,i:res["player"]});break}}canvas.addEventListener("touchstart",handleEvent,false);canvas.addEventListener("touchmove",handleEvent,false);canvas.addEventListener("touchend",handleEvent,false);canvas.addEventListener("gesturestart",handleEvent,false);var objs=[];var obj_fires=[];var player_fires=[];var res=[];var loaded=0;function load_img(d,b){var a=new Image();a.src=b;a.setAttribute("role",d);a.onload=function(){res[this.getAttribute("role")]=this;loaded+=1}}function add_obj(g,a,f,b,e){var d=res[g];objs.push({role:g,x:a,y:f,w:b,h:e,i:d})}function init_player(){var a=center_x;var b=height-50;player={role:"player",x:a,y:b,w:50,h:50,i:res["player"]}}function updateScreen(d){requestID=window.requestAnimationFrame(updateScreen);timer+=1;if(timer===100){var a=Math.floor(Math.random()*width);var e=-100;add_obj("ie",a,e,30,30);timer=0}c.clearRect(0,0,canvas.width,canvas.height);objs.map(function(g,f,h){g.y+=1;if(g.y>height+g.h){h.splice(f,1)}onCollide(g,player,function(){gameover()});c.drawImage(g.i,g.x-g.w/2,g.y-g.h/2,g.w,g.h)});obj_fire_time+=1;if(obj_fire_time===50){obj_fire_time=0;if(objs.length>0){var b=Math.floor(Math.random()*(objs.length-1));obj_fires.push({role:"obj_fires",x:objs[b].x,y:objs[b].y,w:10,h:10,i:res["ie"]})}}obj_fires.map(function(g,f,h){g.y+=2;onCollide(g,player,function(){gameover()});c.drawImage(g.i,g.x-g.w/2,g.y-g.h/2,g.w,g.h)});player_fires.map(function(h,g,f){h.y-=3;if(h.y<-10){f.splice(g,1)}objs.map(function(l,k,j){onCollide(h,l,function(){j.splice(k,1);f.splice(g,1);die_ie+=1})});obj_fires.map(function(l,k,j){onCollide(h,l,function(){j.splice(k,1);f.splice(g,1)})});c.drawImage(h.i,h.x-h.w/2,h.y-h.h/2,h.w,h.h)});c.drawImage(player.i,player.x-player.w/2,player.y-player.h/2,player.w,player.h);c.font="20px Arial";c.fillStyle="#ff0000";c.fillText("已经消灭 "+die_ie+" 个IE",20,20)}function onCollide(a,f,b){if(a!=f){if(a.x>0&&a.y>0){if(f.x>0&&f.y>0){var d=Math.abs(a.x-f.x);var e=Math.abs(a.y-f.y);if(d<a.w/2||d<f.w/2){if(e<a.h/2||e<f.h/2){b()}}}}}}function startUpdateScreen(){requestID=window.requestAnimationFrame(updateScreen)}function stopUpdateScreen(){window.cancelAnimationFrame(requestID)}function load_finish(){}function check_load(){if(loaded===res_count){load_finish()}else{requestID=window.requestAnimationFrame(check_load)}}function ready(a){load_finish=a;requestID=window.requestAnimationFrame(check_load)}function gameover(){c.fillStyle="#000000";c.globalAlpha=0.5;c.fillRect(0,0,width,height);c.globalAlpha=1;c.font="30px Arial";c.fillStyle="#ff0000";c.fillText("Game Over",width/2-270/2,height/2-15);window.cancelAnimationFrame(requestID);requestID=0;c.fillStyle="#ff0000";c.beginPath();c.fillStyle="#ff0000";c.rect(10,height-100,width-20,90);c.fill();c.closePath();c.font="30px Arial";c.fillStyle="#ffffff";c.fillText("restart",30,height-60)}load_img("ie","ie.png");load_img("player","chrome.png");res_count=2;ready(function(){restart()});function restart(){init_player();objs.length=0;obj_fires.length=0;player_fires.length=0;timer=0;obj_fire_time=0;die_ie=0;startUpdateScreen()};